/home/other/johna/.local/lib/python3.10/site-packages/pandas/core/computation/expressions.py:21: UserWarning: Pandas requires version '2.8.4' or newer of 'numexpr' (version '2.8.1' currently installed).
  from pandas.core.computation.check import NUMEXPR_INSTALLED
/home/other/johna/.local/lib/python3.10/site-packages/pandas/core/arrays/masked.py:61: UserWarning: Pandas requires version '1.3.6' or newer of 'bottleneck' (version '1.3.2' currently installed).
  from pandas.core import (
/usr/lib/python3/dist-packages/scipy/__init__.py:146: UserWarning: A NumPy version >=1.17.3 and <1.25.0 is required for this version of SciPy (detected version 1.26.4
  warnings.warn(f"A NumPy version >={np_minversion} and <{np_maxversion}"
Loading datasets...
Using GRA bulk density as target (4M samples vs 26K MAD samples)

  Loading GRA (contains target bulk density - 4M samples!)...
    GRA shape: (4134647, 32)

  Loading and aggregating other datasets by section...
  Loading MAD (moisture and density - will aggregate)...
    MAD aggregated shape: (24496, 27)
  Loading MS (magnetic susceptibility)...
    MS aggregated shape: (66514, 12)
  Loading NGR (natural gamma radiation)...
    NGR aggregated shape: (64451, 27)
  Loading RGB (color data)...
    RGB aggregated shape: (45808, 27)
  Loading SRM (remanent magnetization)...
    SRM aggregated shape: (55633, 23)
  Loading PWL (P-wave logger)...
    PWL aggregated shape: (34861, 17)
  Loading smaller datasets (no aggregation)...
  Loading CARB (carbonate content)...
    CARB shape: (14713, 34)
  Loading ICP (inductively coupled plasma)...
    ICP shape: (3189, 187)
  Loading PWC (P-wave velocity)...
    PWC shape: (28445, 41)

Merging datasets on core identification fields...
  Merging MAD...
  Merging MS...
  Merging NGR...
  Merging RGB...
  Merging SRM...
  Merging PWL...
  Merging CARB...
  Merging ICP...
  Merging PWC...

Merged dataset shape: (4240634, 328)
Rows before removing missing targets: 4240634
Rows after removing missing targets: 4240634

Total features: 311
Categorical features: 28
Numerical features: 283

Dataset info:
  Total samples: 4,240,634
  Features: 311
  Categorical features: 28

Sampling 10.0% of data for tractable training...
  Sampled size: 424,063

Data splits:
  Train: 296,844 samples (70.0%)
  Validation: 63,609 samples (15.0%)
  Test: 63,610 samples (15.0%)

Training CatBoost model with early stopping...
0:	learn: 0.3456241	test: 0.3394036	best: 0.3394036 (0)	total: 165ms	remaining: 5m 29s
100:	learn: 0.2559304	test: 0.2559427	best: 0.2559427 (100)	total: 13.6s	remaining: 4m 16s
200:	learn: 0.2482179	test: 0.2521902	best: 0.2521902 (200)	total: 27s	remaining: 4m 1s
300:	learn: 0.2438477	test: 0.2507805	best: 0.2507805 (300)	total: 40s	remaining: 3m 45s
400:	learn: 0.2409678	test: 0.2501103	best: 0.2501053 (396)	total: 53.4s	remaining: 3m 32s
500:	learn: 0.2378913	test: 0.2496050	best: 0.2495392 (498)	total: 1m 6s	remaining: 3m 19s
600:	learn: 0.2354478	test: 0.2492595	best: 0.2492595 (600)	total: 1m 20s	remaining: 3m 6s
700:	learn: 0.2332009	test: 0.2489416	best: 0.2489305 (697)	total: 1m 33s	remaining: 2m 53s
800:	learn: 0.2308708	test: 0.2485830	best: 0.2485789 (794)	total: 1m 47s	remaining: 2m 40s
900:	learn: 0.2290546	test: 0.2484112	best: 0.2483904 (895)	total: 2m 1s	remaining: 2m 27s
1000:	learn: 0.2269860	test: 0.2482544	best: 0.2482502 (982)	total: 2m 14s	remaining: 2m 14s
1100:	learn: 0.2249827	test: 0.2480541	best: 0.2480097 (1093)	total: 2m 28s	remaining: 2m
1200:	learn: 0.2231844	test: 0.2478615	best: 0.2478615 (1200)	total: 2m 41s	remaining: 1m 47s
1300:	learn: 0.2214204	test: 0.2476203	best: 0.2476057 (1293)	total: 2m 55s	remaining: 1m 34s
1400:	learn: 0.2198679	test: 0.2475192	best: 0.2474955 (1389)	total: 3m 9s	remaining: 1m 20s
1500:	learn: 0.2183866	test: 0.2473223	best: 0.2473223 (1500)	total: 3m 22s	remaining: 1m 7s
1600:	learn: 0.2168684	test: 0.2473285	best: 0.2472937 (1509)	total: 3m 36s	remaining: 53.9s
Stopped by overfitting detector  (100 iterations wait)

bestTest = 0.2472937418
bestIteration = 1509

Shrink model to first 1510 iterations.

============================================================
MODEL EVALUATION - GRA BULK DENSITY PREDICTION
============================================================

Train Set:
  RMSE: 0.2234 g/cm³
  MAE:  0.1057 g/cm³
  R²:   0.6062

Validation Set:
  RMSE: 0.2473 g/cm³
  MAE:  0.1145 g/cm³
  R²:   0.5006

Test Set:
  RMSE: 0.2537 g/cm³
  MAE:  0.1153 g/cm³
  R²:   0.4998

============================================================
TOP 30 MOST IMPORTANT FEATURES
============================================================
                                        feature  importance
                                    Offset (cm)   15.424057
                                           Site   12.088959
                             Water Depth (mbsl)    5.148668
                 NGR_NGR total counts (cps)_min    3.379376
MS_Magnetic susceptibility (instr. units)_count    3.265032
                                            Exp    3.163627
 MS_Magnetic susceptibility (instr. units)_mean    2.858468
                                           Sect    2.828243
  MS_Magnetic susceptibility (instr. units)_min    2.689366
                                 Full Lithology    2.635989
                            NGR_Error (cps)_min    2.488336
                                  Latitude (DD)    2.447743
                             Expanded Core Type    2.427248
                                           Core    2.404958
                                 Lithology Type    2.144861
                        Degree of Consolidation    1.907620
                              Lithology Subtype    1.873230
                NGR_NGR total counts (cps)_mean    1.850162
                           Simplified Lithology    1.714974
                                 Longitude (DD)    1.670189
                       PWL_Depth CSF-A (m)_mean    1.641835
                                Depth CSF-A (m)    1.478662
                                      Principal    1.427166
                           NGR_Error (cps)_mean    1.373563
  MS_Magnetic susceptibility (instr. units)_std    1.331783
                 NGR_NGR total counts (cps)_std    1.229075
                            NGR_Error (cps)_std    1.228481
              PWL_P-wave velocity xy (m/s)_mean    1.048039
                       NGR_Depth CSF-B (m)_mean    0.951047
                        NGR_Depth CSF-B (m)_min    0.913140

Saving model...
Model saved to: bulk_density_gra_model.cbm
Feature importance saved to: feature_importance_gra.csv

============================================================
DONE!
============================================================

Summary:
  - Predicting GRA bulk density (4M measurements)
  - Used 311 features from 9 datasets
  - Trained on 296,844 samples (10% sample)
  - Test R²: 0.4998
  - Early stopping at iteration 1510

Note: This is on 10% sample. Can train on full 4M dataset for production.
